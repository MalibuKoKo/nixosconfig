---
- name: Configure Proxmox Dual NIC Networking and Hostname
  hosts: proxmox_hosts
  become: true
  gather_facts: true # Reliably get the node's actual hostname

  vars:
    # --- Define your NICs and Network Configuration ---

    # WAN/LAN Network (for Host Internet, VMs, and Primary Management)
    wan_lan_nic_phys: "enp8s0"
    wan_lan_bridge_name: "vmbr0"
    wan_lan_bridge_ip_cidr: "192.168.1.12/24"

    # Secondary/Physical Management Network (e.g., for a dedicated physical link)
    management_nic_phys: "enx00e04c78687d"
    management_bridge_name: "vmbr1"
    management_bridge_ip_cidr: "192.168.11.12/24"
    management_gateway_ip: "192.168.11.1"

    # General Network Settings
    gateway_ip: "192.168.1.1" # The default gateway for the PRIMARY WAN/LAN
    dns_servers:
      - "192.168.1.1"
      - "8.8.8.8"

  pre_tasks:
    - name: Ensure ifupdown2 is installed for safe network reloading
      ansible.builtin.apt:
        name: ifupdown2
        state: present
        update_cache: yes

  tasks:
    - name: Backup the current /etc/network/interfaces file
      ansible.builtin.copy:
        src: /etc/network/interfaces
        dest: "/etc/network/interfaces.bak-{{ lookup('pipe', 'date +%Y%m%dT%H%M%S') }}"
        remote_src: true
        owner: root
        group: root
        mode: "0644"
      register: backup_result
      changed_when: false

    - name: Ensure /etc/hosts maps the hostname to the primary IP address
      ansible.builtin.lineinfile:
        path: /etc/hosts
        regexp: '.*\s{{ ansible_hostname }}$'
        line: "{{ wan_lan_bridge_ip_cidr | ipaddr('address') }} {{ ansible_hostname }}"
        owner: root
        group: root
        mode: "0644"

    - name: Generate the new network configuration from template
      ansible.builtin.template:
        src: templates/interfaces.j2
        dest: /etc/network/interfaces
        owner: root
        group: root
        mode: "0644"
        backup: yes
      notify: Apply Network Changes and Reboot

  # ==============================================================================
  # CORRECTED HANDLER BLOCK
  # The 'name' is what the 'notify' statement calls. The block of tasks is what
  # gets executed when the handler is triggered.
  # ==============================================================================
  handlers:
    - name: Apply Network Changes and Reboot
      block:
        - name: Reload network configuration with ifreload
          ansible.builtin.command:
            cmd: "ifreload -a"
          register: network_apply
          changed_when: true
          failed_when: network_apply.rc != 0

        - name: Reboot the host to ensure all changes are active
          ansible.builtin.reboot:
            msg: "Rebooting host to apply network and hostname configuration."
            reboot_timeout: 360
